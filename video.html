<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/css/custom.css">
  </head>
  <body>

    <main role="main" class="container mt-2">
      <h1>Game Details</h1>

      <p>Join using this URL: <code><a id="joinurl">...</a></code></p>

      <div class="form-group">
        <label for="exampleInputFile">Upload the game video</label>
        <input type="file" id="selector" accept="video/*" class="form-control-file" aria-describedby="selector">
        <small id="selector" class="form-text text-muted">You can only upload video files (e.g. <code>mp4</code>, <code>wav</code>,)</small>
      </div>

      <button type="button" id="fullscreen" class="btn btn-primary btn-lg mb-2">Fullscreen</button>

      <div id="videocontainer">
        <video id="video" controls width="100%" height="100%"></video>
        <div id="messagediv">
          <p id="message"></p>
        </div>
      </div>
      <ul id="players"></ul>

    </main>
    <script>
var currentPath = window.location.pathname; // "/video/1234"
var videoId = currentPath.substring(7); // "1234"

var videoContainer = document.getElementById("videocontainer");
var videoPlayer = document.getElementById("video");
var playerList = document.getElementById("players");
var messageArea = document.getElementById("messagediv");
var messageElement = document.getElementById("message");
var fullscreenButton = document.getElementById("fullscreen");

// Select a local video
var fileSelector = document.getElementById("selector");
function setVideo() {
  var file = fileSelector.files[0];
  var videoType = file.type;
  var canPlay = videoPlayer.canPlayType(videoType);
  if(canPlay === "" || canPlay === "no") {
    alert("Video format not supported");
    return;
  }
  var fileURL = URL.createObjectURL(file);
  videoPlayer.src = fileURL;
}

fileSelector.addEventListener("change", setVideo);

// Go fullscreen
fullscreenButton.addEventListener("click", function() {
  videoContainer.requestFullscreen();
});

// Show join URL
var joinUrl = document.getElementById("joinurl");
joinUrl.innerText = window.location.host + "/" + videoId;
joinUrl.href = window.location.protocol + "//" + window.location.host + "/" + videoId;

// Player list
players = {};
function updatePlayers() {
  playerList.innerHTML = "";
  var names = Object.keys(players);
  names.sort();
  for(var i = 0; i < names.length; ++i) {
    var elem = document.createElement("li");
    elem.innerText = names[i];
    playerList.appendChild(elem);
  }
}

var pauseTimeout = undefined;

function resume() {
  messageElement.innerText = "";
  messageArea.style.display = "none";
  videoPlayer.play();
  pauseTimeout = undefined;
}

// Receive buzzes
var wsProto = "wss:";
if(window.location.protocol === "http:") {
  wsProto = "ws:";
}
var socket;
function connect() {
  console.log("Connecting...");
  socket = new WebSocket(wsProto + "//" + window.location.host + "/api/host/" + videoId);
  socket.addEventListener("open", function() { console.log("Connected"); });
  socket.addEventListener("message", function(e) {
    console.log("Message: ", e.data);
    if(e.data.startsWith("join ")) {
      var name = e.data.substring(5);
      players[name] = {};
      updatePlayers();
    } else if(e.data.startsWith("buzz ")) {
      if(pauseTimeout === undefined) {
        var name = e.data.substring(5);
        messageElement.innerText = name + " buzzed!";
        messageArea.style.display = "";
        videoPlayer.pause();
        pauseTimeout = setTimeout(resume, 5000);
      }
    }
  });
  socket.addEventListener("close", function() { setTimeout(connect, 2000); });
}
connect();
    </script>
  </body>
</html>
